<!DOCTYPE html>  
<html>  
<head>  
  <title>ZGG网页版终端</title>  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css">
  <style>
    body {margin:0;padding:10px;background:#555}
    #app {position:fixed;top:0;bottom:0;left:0;right:0}
  </style>
</head>  
<body>  
  <div id="app">
    <div id="console"></div>  
  </div>
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
  <script>  
    var term = new Terminal({
        disableStdin: false,
        cursorBlink: true,
    })
    var fit = new FitAddon.FitAddon()
    term.loadAddon(fit)
    term.open(document.getElementById('console'))
    fit.fit()
    term.prompt = function() {
        return term.write("\r\n\x1b[33mzgg>\x1b[0m ")
    }
    var input = ''
    term.onKey(e => {
        const printable = !e.domEvent.altKey && !e.domEvent.altGraphKey && !e.domEvent.ctrlKey && !e.domEvent.metaKey
        if (e.domEvent.keyCode === 13) {
            term.write('\r\n')
            console.log('buffer', term._core.buffer)
            session.send(JSON.stringify({
                type: 'INPUT',
                content: input,
            }))
            input = ''
        } else if (e.domEvent.keyCode === 8) { // back 删除的情况
            if (term._core.buffer.x > 5) {
                term.write('\b \b')
                input = input.substr(0, input.length - 1)
            }
        } else if (printable) {
            input += e.key
            term.write(e.key)
        }
    })
    term.onData(key => {  // 粘贴的情况
        if(key.length > 1) {
            term.write(key)
            input += key
        }
    })
    window.addEventListener('resize', () => fit.fit())
    term.focus()

    // init websocket
    var wsUrl = location.href.replace(/^http/i, 'ws') + '/session'
    var session
    function initSession() {
        session = new WebSocket(wsUrl)
        session.onmessage = function(e) {
            try {
                var data = JSON.parse(e.data)
                switch (data.type) {
                case 'STDOUT':
                case 'STDERR':
                    term.write(data.content.replace(/\n/g, '\r\n'))
                    break
                case 'TABLE':
                    term.write(data.content.replace(/\n/g, '\r\n'))
                    term.prompt()
                    break
                case 'RETURN':
                    var output = '\033[36m' + data.content.replace(/\n/g, '\r\n') + '\033[0m'
                    term.write(output)
                    term.prompt()
                    break
                }
            } catch(e) {
                console.error(e)
            }
        }
        session.onopen = function() {
            setTimeout(() => term.prompt(), 300)
        }
        session.onclose = function() {
            term.writeln('连接已断开，1秒后重连...')
            setTimeout(initSession, 1000)
        }
    }
    initSession()
  </script>  
</body>  
</html>